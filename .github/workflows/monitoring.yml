name: 'Monitoreo Sistema Service Bus'

on:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-messaging-dev  # Cambiar segÃºn tu configuraciÃ³n
  PROJECT_NAME: messaging
  ENVIRONMENT: dev

jobs:
  health-check:
    name: 'Health Check'
    runs-on: ubuntu-latest
    
    steps:
      - name: Login Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
            
      - name: Check Service Bus Status
        run: |
          echo "ðŸ” Verificando Service Bus..."
          
          # Obtener informaciÃ³n del Service Bus
          NAMESPACE=$(az servicebus namespace list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[0].name" -o tsv)
          
          STATUS=$(az servicebus namespace show \
            --name $NAMESPACE \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "status" -o tsv)
          
          echo "Service Bus Status: $STATUS"
          
          if [ "$STATUS" = "Active" ]; then
            echo "âœ… Service Bus estÃ¡ funcionando correctamente"
          else
            echo "âŒ Service Bus tiene problemas"
            exit 1
          fi
          
      - name: Check Function App Status
        run: |
          echo "ðŸ” Verificando Function App..."
          
          FUNC_NAME=$(az functionapp list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[0].name" -o tsv)
          
          STATUS=$(az functionapp show \
            --name $FUNC_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "state" -o tsv)
          
          echo "Function App Status: $STATUS"
          
          if [ "$STATUS" = "Running" ]; then
            echo "âœ… Function App estÃ¡ funcionando correctamente"
          else
            echo "âš ï¸ Function App no estÃ¡ ejecutÃ¡ndose, reiniciando..."
            az functionapp restart --name $FUNC_NAME --resource-group ${{ env.RESOURCE_GROUP }}
          fi
          
      - name: Generate Report
        run: |
          echo "## ðŸ“Š Reporte de Monitoreo - $(date)" >> $GITHUB_STEP_SUMMARY
          echo "### Estado de Servicios:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Service Bus: Activo" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Function App: EjecutÃ¡ndose" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Monitoreo: Funcionando" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PrÃ³xima verificaciÃ³n:** $(date -d '+6 hours')" >> $GITHUB_STEP_SUMMARY
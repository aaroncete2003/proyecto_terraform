name: 'Monitoreo Sistema Service Bus'

on:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-messaging-dev  # Cambiar según tu configuración
  PROJECT_NAME: messaging
  ENVIRONMENT: dev

jobs:
  health-check:
    name: 'Health Check'
    runs-on: ubuntu-latest
    
    steps:
      - name: Login Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
            
      - name: Check Service Bus Status
        run: |
          echo "🔍 Verificando Service Bus..."
          
          # Obtener información del Service Bus
          NAMESPACE=$(az servicebus namespace list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[0].name" -o tsv)
          
          STATUS=$(az servicebus namespace show \
            --name $NAMESPACE \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "status" -o tsv)
          
          echo "Service Bus Status: $STATUS"
          
          if [ "$STATUS" = "Active" ]; then
            echo "✅ Service Bus está funcionando correctamente"
          else
            echo "❌ Service Bus tiene problemas"
            exit 1
          fi
          
      - name: Check Function App Status
        run: |
          echo "🔍 Verificando Function App..."
          
          FUNC_NAME=$(az functionapp list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[0].name" -o tsv)
          
          STATUS=$(az functionapp show \
            --name $FUNC_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "state" -o tsv)
          
          echo "Function App Status: $STATUS"
          
          if [ "$STATUS" = "Running" ]; then
            echo "✅ Function App está funcionando correctamente"
          else
            echo "⚠️ Function App no está ejecutándose, reiniciando..."
            az functionapp restart --name $FUNC_NAME --resource-group ${{ env.RESOURCE_GROUP }}
          fi
          
      - name: Generate Report
        run: |
          echo "## 📊 Reporte de Monitoreo - $(date)" >> $GITHUB_STEP_SUMMARY
          echo "### Estado de Servicios:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Service Bus: Activo" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Function App: Ejecutándose" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Monitoreo: Funcionando" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Próxima verificación:** $(date -d '+6 hours')" >> $GITHUB_STEP_SUMMARY